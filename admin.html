<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - RS Transport Solution</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .branding { text-align: center; color: #1a73e8; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        form { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        h3 { grid-column: span 3; color: #1a73e8; border-bottom: 1px solid #ddd; margin-top: 20px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .full-width { grid-column: span 3; }
        
        button.add-btn { grid-column: span 3; background-color: #1a73e8; color: white; border: none; padding: 15px; cursor: pointer; font-weight: bold; border-radius: 5px; font-size: 16px; margin-top: 10px;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; font-size: 14px; }
        .gender-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .M { background: #e3f2fd; color: #1976d2; }
        .F { background: #fce4ec; color: #c2185b; }
    </style>
</head>
<body>

<div class="container">
    <div class="branding">
        <h1>RS Transport Solution</h1>
        <p>Iqra International School Tokyo | Admin Management</p>
    </div>

    <form id="registrationForm">
        <h3>1. Student Information</h3>
        <input type="text" id="studentName" placeholder="Student Full Name" required>
        <input type="date" id="dob" title="Date of Birth" required>
        <select id="gender" required>
            <option value="">Select Gender</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
        </select>
        <input type="text" id="address" placeholder="Pickup Address" class="full-width" required>

        <h3>2. Parent / Guardian Information</h3>
        <input type="text" id="fatherName" placeholder="Father's Name">
        <input type="tel" id="fatherPhone" placeholder="Father's Phone">
        <select id="primaryContact">
            <option value="Father">Father is Primary</option>
            <option value="Mother">Mother is Primary</option>
        </select>
        
        <input type="text" id="motherName" placeholder="Mother's Name">
        <input type="tel" id="motherPhone" placeholder="Mother's Phone">
        <div style="visibility: hidden;">placeholder</div>

        <h3>3. Login Credentials (Use same email for siblings)</h3>
        <input type="email" id="userEmail" placeholder="Parent Email (Login ID)" required>
        <input type="password" id="userPassword" placeholder="Set Password (only for new users)">
        
        <button type="submit" class="add-btn">Register Student</button>
    </form>

    <hr>

    <h2>Registered Students</h2>
    <table>
        <thead>
            <tr>
                <th>Student</th>
                <th>Gender</th>
                <th>DoB</th>
                <th>Primary Parent</th>
                <th>Phone</th>
                <th>Pickup Address</th>
            </tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCS163x5b5-MJXxJGwbjE0IlO7R58CkJMg",
        authDomain: "maktab-transport.firebaseapp.com",
        projectId: "maktab-transport",
        storageBucket: "maktab-transport.firebasestorage.app",
        messagingSenderId: "575357634901",
        appId: "1:575357634901:web:4918fb77b0c21965af07dc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('userEmail').value;
        const password = document.getElementById('userPassword').value;

        try {
            let uid = "";
            
            // Check if parent already exists
            const q = query(collection(db, "users"), where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // NEW PARENT: Create Auth and User Profile
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                uid = userCredential.user.uid;
                await addDoc(collection(db, "users"), {
                    uid: uid,
                    role: "parent",
                    email: email,
                    fatherName: document.getElementById('fatherName').value,
                    motherName: document.getElementById('motherName').value,
                    fatherPhone: document.getElementById('fatherPhone').value,
                    motherPhone: document.getElementById('motherPhone').value,
                    primaryContact: document.getElementById('primaryContact').value
                });
            } else {
                // EXISTING PARENT: Just get their UID
                uid = querySnapshot.docs[0].data().uid;
            }

            // Always create a new Student document linked to that UID
            await addDoc(collection(db, "students"), {
                parentUid: uid,
                name: document.getElementById('studentName').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value,
                school: "Iqra International School Tokyo",
                status: "Awaiting Pickup"
            });

            alert("Student Registered Successfully!");
            document.getElementById('registrationForm').reset();
        } catch (error) { alert(error.message); }
    });

    // DISPLAY LIST
    onSnapshot(collection(db, "students"), (snapshot) => {
        const tableBody = document.getElementById('studentTableBody');
        tableBody.innerHTML = "";
        snapshot.forEach((docData) => {
            const s = docData.data();
            tableBody.innerHTML += `
                <tr>
                    <td><strong>${s.name}</strong></td>
                    <td><span class="gender-badge ${s.gender}">${s.gender}</span></td>
                    <td>${s.dob}</td>
                    <td>Parent Account</td>
                    <td>${s.address}</td>
                    <td><button style="background:red; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">Delete</button></td>
                </tr>
            `;
        });
    });
</script>
</body>
</html>
