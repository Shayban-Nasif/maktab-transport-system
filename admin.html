<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - RS Transport Solution</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        form { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        h3 { grid-column: span 3; color: #1a73e8; border-bottom: 1px solid #ddd; margin-bottom: 5px; }
        input, select, button { padding: 12px; border-radius: 5px; border: 1px solid #ddd; }
        button { background: #1a73e8; color: white; font-weight: bold; cursor: pointer; grid-column: span 3; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        .full { grid-column: span 3; }
    </style>
</head>
<body>
<div class="container">
    <h1>RS Transport Solution Admin</h1>
    <form id="regForm">
        <h3>User Account</h3>
        <input type="email" id="email" placeholder="Email (Login ID)" required>
        <input type="password" id="password" placeholder="Password" required>
        <select id="role" class="full" onchange="toggleForm()">
            <option value="parent">Parent</option>
            <option value="driver">Driver</option>
        </select>

        <div id="parentFields" class="full" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
            <h3>Student & Parent Info</h3>
            <input type="text" id="studentName" placeholder="Student Name">
            <input type="date" id="dob">
            <select id="gender"><option value="M">Male</option><option value="F">Female</option></select>
            <input type="text" id="fatherName" placeholder="Father's Name">
            <input type="text" id="motherName" placeholder="Mother's Name">
            <input type="text" id="address" placeholder="Pickup Address" class="full">
        </div>

        <div id="driverFields" class="full" style="display: none;">
            <h3>Driver Info</h3>
            <input type="text" id="driverName" placeholder="Driver Full Name">
            <input type="text" id="carNumber" placeholder="Car Plate Number">
        </div>
        
        <button type="submit">Create Profile & Register</button>
    </form>

    <h2>Database Records</h2>
    <table id="userTable">
        <thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Details</th></tr></thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCS163x5b5-MJXxJGwbjE0IlO7R58CkJMg",
        authDomain: "maktab-transport.firebaseapp.com",
        projectId: "maktab-transport",
        storageBucket: "maktab-transport.firebasestorage.app",
        messagingSenderId: "575357634901",
        appId: "1:575357634901:web:4918fb77b0c21965af07dc"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // SECURITY GUARD: Uncomment this after creating your first Admin account
    /*
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const q = query(collection(db, "users"), where("uid", "==", user.uid));
            const snap = await getDocs(q);
            if (snap.empty || snap.docs[0].data().role !== 'admin') { window.location.href = "login.html"; }
        } else { window.location.href = "login.html"; }
    });
    */

    window.toggleForm = () => {
        const role = document.getElementById('role').value;
        document.getElementById('parentFields').style.display = role === 'parent' ? 'grid' : 'none';
        document.getElementById('driverFields').style.display = role === 'driver' ? 'block' : 'none';
    };

    document.getElementById('regForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        try {
            let uid;
            const q = query(collection(db, "users"), where("email", "==", email));
            const snap = await getDocs(q);

            if (snap.empty) {
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                uid = userCred.user.uid;
                await addDoc(collection(db, "users"), { 
                    uid, email, role, 
                    name: role === 'driver' ? document.getElementById('driverName').value : document.getElementById('fatherName').value 
                });
            } else {
                uid = snap.docs[0].data().uid;
            }

            if (role === 'parent') {
                await addDoc(collection(db, "students"), {
                    parentUid: uid,
                    name: document.getElementById('studentName').value,
                    address: document.getElementById('address').value,
                    gender: document.getElementById('gender').value,
                    status: "Awaiting Pickup"
                });
            }
            alert("Success!");
        } catch (err) { alert(err.message); }
    });

    onSnapshot(collection(db, "users"), (snap) => {
        const list = document.getElementById('userList');
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            list.innerHTML += `<tr><td>${u.name}</td><td>${u.role}</td><td>${u.email}</td><td>ID: ${u.uid.slice(0,5)}...</td></tr>`;
        });
    });
</script>
</body>
</html>
