<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes" />
  <title>RS Transport Solution - Enhanced</title>
  <!-- Add Firebase Cloud Messaging -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <!-- Add Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="manifest" href="/manifest.json">
  <style>
    :root {
      --admin: #1a73e8;
      --driver: #28a745;
      --parent: #ff9800;
      --bg: #f4f7f9;
      --danger: #dc3545;
      --dark: #1e293b;
      --route: #6366f1;
      --logs: #64748b;
      --done: #94a3b8;
      --warning: #ffc107;
      --success: #28a745;
      --info: #17a2b8;
    }
    
    body {
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: var(--bg);
      margin: 0;
      min-height: 100vh;
      color: #1e293b;
    }
    
    .header-bar {
      background: var(--dark);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      flex-wrap: wrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .container {
      width: 98%;
      max-width: 1400px;
      margin: 20px auto;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Modern Card Design */
    .card {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.03);
      margin-bottom: 24px;
      border: 1px solid rgba(0,0,0,0.03);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      box-shadow: 0 12px 28px rgba(0,0,0,0.05);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    
    /* Enhanced Scroll Box */
    .scroll-box {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #edf2f7;
      border-radius: 12px;
      background: white;
      padding: 4px;
    }
    
    /* Modern Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    
    th {
      background: #f8fafc;
      color: #475569;
      font-weight: 600;
      padding: 16px 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 2px solid #e2e8f0;
    }
    
    td {
      padding: 14px 12px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    /* Better Buttons */
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    button i {
      font-size: 1rem;
    }
    
    button:active {
      transform: scale(0.96);
    }
    
    .btn-ready {
      background: var(--driver);
      color: white;
    }
    
    .btn-ready:hover {
      background: #218838;
    }
    
    .btn-leave {
      background: var(--danger);
      color: white;
    }
    
    .btn-route {
      background: var(--route);
      color: white;
    }
    
    .btn-outline {
      background: white;
      border: 2px solid #cbd5e1;
      color: #334155;
    }
    
    .btn-outline:hover {
      background: #f8fafc;
    }
    
    /* Driver Card - Enhanced */
    .driver-student-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 6px solid var(--driver);
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      transition: all 0.3s;
    }
    
    .driver-student-card.leave {
      border-left-color: var(--danger);
      opacity: 0.8;
    }
    
    .driver-student-card.next-stop {
      border-left-color: var(--warning);
      background: #fffbeb;
    }
    
    .stop-badge {
      background: #e2e8f0;
      padding: 6px 14px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 0.8rem;
    }
    
    /* Progress Bar */
    .progress-container {
      background: #edf2f7;
      border-radius: 30px;
      height: 12px;
      margin: 16px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      background: var(--driver);
      height: 100%;
      border-radius: 30px;
      transition: width 0.5s;
    }
    
    /* Duration Picker */
    .duration-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    
    .duration-btn {
      padding: 8px 16px;
      background: #f1f5f9;
      border-radius: 30px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .duration-btn:hover {
      background: #e2e8f0;
    }
    
    .duration-btn.selected {
      background: var(--route);
      color: white;
    }
    
    /* Parent Dashboard */
    .parent-child-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border-top: 4px solid var(--parent);
    }
    
    .child-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .child-tab {
      padding: 12px 24px;
      background: #f1f5f9;
      border-radius: 40px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .child-tab.active {
      background: var(--parent);
      color: white;
    }
    
    .status-chip {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      border-radius: 40px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      font-size: 0.85rem;
    }
    
    .push-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 12px;
      border-left: 4px solid var(--info);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header-bar {
        flex-direction: column;
        text-align: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .driver-student-card .row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <script>
// Register Service Worker immediately when page loads
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then(function(registration) {
        console.log('‚úÖ Service Worker registered successfully:', registration.scope);
      })
      .catch(function(err) {
        console.log('‚ùå Service Worker registration failed:', err);
      });
  });
}
</script>
  
<header class="header-bar">
  <div class="header-titles">
    <h1><i class="fas fa-bus"></i> RS TRANSPORT SOLUTION</h1>
    <p style="margin:4px 0 0; font-size:0.7rem; opacity:0.9;">Iqra International School Tokyo - Enhanced Edition</p>
  </div>
  <div id="userInfo" class="hidden" style="display:flex; flex-direction:column; align-items:flex-end;">
    <div id="userDisplayName" style="font-size:0.9rem; font-weight:bold;"></div>
    <div id="portalLabel"></div>
    <div id="connectionStatus" class="status-chip" style="margin-top:6px;">
      <i class="fas fa-wifi"></i> <span id="statusText">Connected</span>
    </div>
  </div>
</header>

<div class="container">
  <!-- Login Section -->
  <div id="loginSection" class="card" style="max-width:400px; margin:60px auto; text-align:center;">
    <i class="fas fa-bus" style="font-size:48px; color:var(--dark); margin-bottom:16px;"></i>
    <h2 style="margin-bottom:24px;">Transport System Login</h2>
    <form id="loginForm">
      <div style="margin-bottom:16px; text-align:left;">
        <label style="font-size:0.85rem; font-weight:600;">Email</label>
        <input type="email" id="email" placeholder="Enter your email" required style="margin-top:4px;">
      </div>
      <div style="margin-bottom:24px; text-align:left;">
        <label style="font-size:0.85rem; font-weight:600;">Password</label>
        <input type="password" id="password" placeholder="Enter your password" required style="margin-top:4px;">
      </div>
      <button type="submit" style="background:var(--admin); color:white; width:100%; padding:14px;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
    </form>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
      <div>
        <button onclick="window.handleRefresh()" class="btn-outline" style="padding:10px 18px;">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <span id="lastRefreshTime" class="mini" style="margin-left:12px;">Last updated: Just now</span>
      </div>
      <button onclick="window.handleLogout()" class="btn-gray" style="background:#475569; color:white;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
    
    <!-- Push Notification Permission Banner (only for parents) -->
    <div id="pushPermissionBanner" class="hidden push-toggle" style="margin-bottom:20px;">
      <i class="fas fa-bell" style="color:var(--info);"></i>
      <span style="flex:1;">Get real-time notifications about your child's transportation</span>
      <button onclick="window.requestNotificationPermission()" style="background:var(--info); color:white; padding:8px 20px;">
        <i class="fas fa-bell"></i> Enable
      </button>
    </div>
    
    <div id="dynamicContent"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, collection, query, where, getDocs, getDoc, onSnapshot,
    doc, updateDoc, setDoc, deleteDoc, addDoc, serverTimestamp,
    orderBy, limit, writeBatch, increment
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCS163x5b5-MJXxJGwbjE0IlO7R58CkJMg",
    authDomain: "maktab-transport.firebaseapp.com",
    projectId: "maktab-transport",
    storageBucket: "maktab-transport.firebasestorage.app",
    messagingSenderId: "575357634901",
    appId: "1:575357634901:web:4918fb77b0c21965af07dc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const secAuth = getAuth(initializeApp(firebaseConfig, "Secondary"));

  // ============== FCM INITIALIZATION WITH VAPID KEY ==============
let messaging = null;

// Wait for service worker to be ready
if ('serviceWorker' in navigator && 'PushManager' in window) {
  console.log("‚úÖ Push notifications are supported");
  
  try {
    // Initialize messaging with explicit service worker registration
    navigator.serviceWorker.ready.then(registration => {
      console.log("‚úÖ Service Worker ready, initializing FCM...");
      
      messaging = firebase.messaging(app);
      
      // Use the registered service worker
      messaging.useServiceWorker(registration);
      
      console.log("‚úÖ FCM initialized successfully with service worker");
    });
  } catch (e) {
    console.log("‚ùå FCM initialization error:", e);
  }
} else {
  console.log("‚ùå Push notifications are not supported in this browser");
}

// ============== REQUEST NOTIFICATION PERMISSION & GET TOKEN ==============
window.requestNotificationPermission = async () => {
  if (!messaging) {
    alert("Push notifications not available - FCM not initialized");
    return;
  }
  
  try {
    // üî¥ IMPORTANT: Replace with your ACTUAL VAPID key from Step 1
    const VAPID_KEY = "BAA2c2R09q_WHKNY7HCgD8wkAr9Mhif2AOZ1_BSx9aSBn5e5eXjDOCppnksF9w39KeV7A9bI_lcjFXTCjJyjnqc"; // <-- PASTE YOUR KEY HERE!
    
    const permission = await Notification.requestPermission();
    console.log("Notification permission:", permission);
    
    if (permission === 'granted') {
      const token = await messaging.getToken({ vapidKey: VAPID_KEY });
      console.log('FCM Token:', token);
      
      // Save token to user document in Firestore
      const user = auth.currentUser;
      if (user) {
        const userQuery = query(collection(db, "users"), where("uid", "==", user.uid));
        const userSnap = await getDocs(userQuery);
        if (!userSnap.empty) {
          const userDoc = userSnap.docs[0];
          // Get existing tokens or create new array
          const existingTokens = userDoc.data().fcmTokens || [];
          
          // Add token if not already present
          if (!existingTokens.includes(token)) {
            await updateDoc(userDoc.ref, {
              fcmTokens: [...existingTokens, token],
              notificationsEnabled: true,
              lastTokenUpdate: serverTimestamp()
            });
            console.log("Token saved to user document");
          }
        }
      }
      
      alert('‚úÖ Notifications enabled! You will receive real-time updates.');
      document.getElementById('pushPermissionBanner')?.classList.add('hidden');
      return token;
    } else {
      alert('‚ùå Notification permission denied. Please enable in browser settings.');
    }
  } catch (err) {
    console.error('Notification error:', err);
    
    // Specific error handling
    if (err.code === 'messaging/permission-blocked') {
      alert('Notifications are blocked. Please unblock in your browser settings.');
    } else if (err.code === 'messaging/invalid-vapid-key') {
      alert('Invalid VAPID key. Please check your Firebase configuration.');
    } else {
      alert('Failed to enable notifications: ' + err.message);
    }
  }
};

  // Global State
  let routesList = [];
  let driverMap = {};
  let parentStudentsMap = {}; // For multiple kids per parent
  let lastRefresh = new Date();
  let activeListeners = [];

  // ============== PUSH NOTIFICATIONS ==============
  window.requestNotificationPermission = async () => {
    if (!messaging) {
      alert("Push notifications not available");
      return;
    }
    
    try {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        const token = await messaging.getToken({ vapidKey: 'YOUR_VAPID_KEY' });
        console.log('FCM Token:', token);
        
        // Save token to user document
        const user = auth.currentUser;
        if (user) {
          const userQuery = query(collection(db, "users"), where("uid", "==", user.uid));
          const userSnap = await getDocs(userQuery);
          if (!userSnap.empty) {
            await updateDoc(userSnap.docs[0].ref, {
              fcmTokens: arrayUnion(token),
              notificationsEnabled: true
            });
          }
        }
        
        alert('Notifications enabled! You will receive real-time updates.');
        document.getElementById('pushPermissionBanner')?.classList.add('hidden');
      }
    } catch (err) {
      console.error('Notification error:', err);
    }
  };

  // Send notification to parent
  async function sendPushNotification(parentUid, title, body, data = {}) {
    // Find parent's FCM tokens
    const userQuery = query(collection(db, "users"), where("uid", "==", parentUid));
    const userSnap = await getDocs(userQuery);
    if (userSnap.empty) return;
    
    const userData = userSnap.docs[0].data();
    const tokens = userData.fcmTokens || [];
    
    if (tokens.length === 0) return;
    
    // In production, send to your server endpoint
    console.log(`Sending notification to ${parentUid}: ${title} - ${body}`);
    
    // Store notification in Firestore for in-app display
    await addDoc(collection(db, "notifications"), {
      uid: parentUid,
      title,
      body,
      data,
      read: false,
      timestamp: serverTimestamp()
    });
  }

  // ============== CUSTOM LOCATIONS ==============
  async function updateStudentLocation(sid, type, address) {
    // type: 'pickup' or 'dropoff'
    const field = type === 'pickup' ? 'pickupLoc' : 'dropoffLoc';
    await updateDoc(doc(db, "students", sid), {
      [field]: address,
      [`${field}UpdatedAt`]: serverTimestamp(),
      [`${field}History`]: arrayUnion({
        address,
        timestamp: new Date().toISOString(),
        updatedBy: auth.currentUser?.uid
      })
    });
  }

  // ============== MULTIPLE KIDS PER PARENT ==============
  // Enhanced parent registration to handle multiple children
  async function registerParentWithKids(parentData, students) {
    // parentData: { email, password, fullName, phone }
    // students: array of student objects
    try {
      const cred = await createUserWithEmailAndPassword(secAuth, parentData.email, parentData.password);
      
      // Create parent user
      await addDoc(collection(db, "users"), {
        uid: cred.user.uid,
        fullName: parentData.fullName,
        email: parentData.email,
        role: "parent",
        phone: parentData.phone || "",
        children: students.map(s => ({ 
          studentId: s.tempId, 
          name: s.name,
          relation: s.relation || 'Parent'
        })),
        createdAt: serverTimestamp()
      });
      
      // Create each student
      for (const student of students) {
        await addDoc(collection(db, "students"), {
          ...student,
          parentUid: cred.user.uid,
          status: "AWAITING",
          stopOrder: null,
          minsAM: null,
          minsPM: null,
          pickupLoc: student.address,
          dropoffLoc: student.address,
          customPickup: null,
          customDropoff: null,
          createdAt: serverTimestamp()
        });
      }
      
      await signOut(secAuth);
      return true;
    } catch (err) {
      throw err;
    }
  }

  // ============== ETA WITH AUTO-REFRESH ==============
  function updateLastRefreshTime() {
    const el = document.getElementById('lastRefreshTime');
    if (el) {
      const now = new Date();
      el.innerText = `Last updated: ${now.toLocaleTimeString()}`;
    }
  }

  // Enhanced ETA calculation with auto-refresh trigger
  function computeEtaForStudentFromDocs(session, studentId, tripStartHM, docs, overridesMap = {}) {
    updateLastRefreshTime();
    
    const base = hmToMinutes(tripStartHM);
    if (base === null) return "--:--";

    const field = (session === "AM") ? "minsAM" : "minsPM";

    const list = docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(s => Number.isFinite(s.stopOrder))
      .sort((a, b) => (a.stopOrder ?? 9999) - (b.stopOrder ?? 9999));

    const me = list.find(x => x.id === studentId);
    if (!me) return "--:--";

    if (session === "AM" && me.doneAM) return "DROPPED";
    if (session === "PM" && me.donePM) return "DROPPED";

    let sum = 0;
    for (const st of list) {
      const override = overridesMap?.[st.id];
      const minsRaw = (override !== undefined && override !== null) ? override : st[field];
      const mins = parseInt(minsRaw ?? "0", 10);
      sum += Number.isFinite(mins) ? mins : 0;

      if (st.id === studentId) return minutesToHM(base + sum);
    }
    return "--:--";
  }

  // ============== DURATION PRESETS ==============
  window.applyDurationPreset = async (sid, session, minutes) => {
    const field = session === "AM" ? "minsAM" : "minsPM";
    await updateDoc(doc(db, "students", sid), {
      [field]: parseInt(minutes, 10)
    });
  };

  window.copyFromActual = async (sid, session) => {
    // Get today's trip and calculate actual duration
    const today = todayISO();
    const studentDoc = await getDoc(doc(db, "students", sid));
    const student = studentDoc.data();
    
    if (!student.routeId) return alert("No route assigned");
    
    const tripId = tripIdFor(student.routeId, today, session);
    const eventsRef = collection(db, "trips", tripId, "events");
    
    // Find pickup and dropoff events for this student
    const pickupEvent = await getDocs(query(
      eventsRef, 
      where("studentId", "==", sid),
      where("type", "in", ["PICKED_AM", "PICKED_SCHOOL_PM"]),
      orderBy("timestamp", "asc"),
      limit(1)
    ));
    
    const dropEvent = await getDocs(query(
      eventsRef,
      where("studentId", "==", sid),
      where("type", "in", ["DROPPED_SCHOOL_AM", "DROPPED_PM"]),
      orderBy("timestamp", "asc"),
      limit(1)
    ));
    
    if (!pickupEvent.empty && !dropEvent.empty) {
      const pickupTime = pickupEvent.docs[0].data().timestamp?.toDate();
      const dropTime = dropEvent.docs[0].data().timestamp?.toDate();
      
      if (pickupTime && dropTime) {
        const diffMinutes = Math.round((dropTime - pickupTime) / 60000);
        if (diffMinutes > 0) {
          await applyDurationPreset(sid, session, diffMinutes);
          alert(`Duration set to ${diffMinutes} minutes based on actual trip`);
        }
      }
    } else {
      alert("No complete trip data available for today");
    }
  };

  // ============== HELPER FUNCTIONS ==============
  const todayISO = () => new Date().toLocaleDateString('en-CA');
  const timeHMNow = () => new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  const defaultSession = () => (new Date().getHours() < 12 ? "AM" : "PM");
  const tripIdFor = (routeId, dateStr, session) => `${routeId}_${dateStr}_${session}`;

  const hmToMinutes = (hm) => {
    if (!hm || !hm.includes(":")) return null;
    const [h, m] = hm.split(":").map(x => parseInt(x, 10));
    if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
    return h * 60 + m;
  };

  const minutesToHM = (mins) => {
    mins = ((mins % (24*60)) + (24*60)) % (24*60);
    const h = String(Math.floor(mins / 60)).padStart(2, "0");
    const m = String(mins % 60).padStart(2, "0");
    return `${h}:${m}`;
  };

  const nowHM = () => {
    const d = new Date();
    return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  };

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function portalLabel(role) {
    const label = document.getElementById('portalLabel');
    label.innerText = role.charAt(0).toUpperCase() + role.slice(1);
    label.className = `portal-tag bg-${role}`;
  }

  const btnId = (sid, field) => `btn_${sid}_${field}`;

  // ============== TRIP FUNCTIONS ==============
  async function ensureTrip(routeId, driverUid, session, startHM) {
    const tid = tripIdFor(routeId, todayISO(), session);
    await setDoc(doc(db, "trips", tid), {
      routeId, driverUid, date: todayISO(), session,
      status: "LIVE",
      tripStartHM: startHM || nowHM(),
      startedAt: serverTimestamp()
    }, { merge: true });
    
    // Notify parents
    const studentsSnap = await getDocs(query(collection(db, "students"), where("routeId", "==", routeId)));
    for (const studentDoc of studentsSnap.docs) {
      const student = studentDoc.data();
      if (student.parentUid) {
        await sendPushNotification(
          student.parentUid,
          "üöå Bus Started",
          `The ${session} trip has started on route ${routeId}`,
          { routeId, session, tripId: tid }
        );
      }
    }

    return tid;
  }

  async function addStudentEvent(routeId, driverUid, session, studentId, studentName, type, extra = {}) {
    const tid = tripIdFor(routeId, todayISO(), session);
    await addDoc(collection(db, "trips", tid, "events"), {
      type, studentId, studentName,
      timestamp: serverTimestamp(),
      routeId, driverUid, session,
      ...extra
    });
    
    // Send notification to parent
    const studentDoc = await getDoc(doc(db, "students", studentId));
    const student = studentDoc.data();
    if (student?.parentUid) {
      let notificationTitle = "";
      let notificationBody = "";
      
      switch(type) {
        case "PICKED_AM":
          notificationTitle = "‚úÖ Picked Up";
          notificationBody = `${studentName} has been picked up for school`;
          break;
        case "DROPPED_SCHOOL_AM":
          notificationTitle = "üè´ Reached School";
          notificationBody = `${studentName} has been dropped at school safely`;
          break;
        case "PICKED_SCHOOL_PM":
          notificationTitle = "üöê School Pickup";
          notificationBody = `${studentName} has been picked up from school`;
          break;
        case "DROPPED_PM":
          notificationTitle = "üè† Home Safe";
          notificationBody = `${studentName} has been dropped home`;
          break;
      }
      
      if (notificationTitle) {
        await sendPushNotification(student.parentUid, notificationTitle, notificationBody, {
          studentId,
          studentName,
          type,
          session
        });
      }
    }
  }

  async function setTripOverride(routeId, session, studentId, mins) {
    const tid = tripIdFor(routeId, todayISO(), session);
    await setDoc(doc(db, "trips", tid, "overrides", studentId), {
      mins: mins === null ? null : mins,
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  // ============== AUTH ==============
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      await signInWithEmailAndPassword(auth, email.value, password.value);
    } catch {
      alert("Login Failed. Please check your credentials.");
    }
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      return;
    }

    const q = query(collection(db, "users"), where("uid", "==", user.uid));
    const snap = await getDocs(q);
    if (snap.empty) return alert("User profile not found in users collection.");

    const userData = snap.docs[0].data();
    document.getElementById('userDisplayName').innerText = userData.fullName;
    portalLabel(userData.role);
    document.getElementById('userInfo').classList.remove('hidden');

    // Show push notification banner for parents
    if (userData.role === 'parent' && !userData.notificationsEnabled) {
      document.getElementById('pushPermissionBanner')?.classList.remove('hidden');
    }

    // Load routes and drivers
    onSnapshot(collection(db, "routes"), (rSnap) => {
      routesList = rSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      onSnapshot(query(collection(db, "users"), where("role", "==", "driver")), (dSnap) => {
        driverMap = {};
        dSnap.forEach(d => { driverMap[d.data().uid] = d.data(); });
        initDashboard(userData);
      });
    });
  });

  function initDashboard(user) {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('dashboardSection').classList.remove('hidden');
    const target = document.getElementById('dynamicContent');

    // Clear previous listeners
    activeListeners.forEach(unsub => unsub());
    activeListeners = [];

    if (user.role === 'admin') renderAdmin(target);
    else if (user.role === 'driver') renderDriver(target, user.uid);
    else renderParent(target, user.uid);
  }

  // ============== ADMIN VIEW (Enhanced) ==============
  function renderAdmin(target) {
    target.innerHTML = `
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-bottom:20px;">
        <div class="card" style="border-top:6px solid var(--danger);">
          <div style="display:flex; align-items:center; gap:16px;">
            <i class="fas fa-redo-alt" style="font-size:24px; color:var(--danger);"></i>
            <div>
              <h3 style="margin:0;">Reset System</h3>
              <p class="mini">Clear all statuses for new day</p>
            </div>
          </div>
          <button onclick="window.resetAllStudents()" style="background:var(--danger); color:white; width:100%; margin-top:12px;">
            <i class="fas fa-trash"></i> RESET FOR NEW DAY
          </button>
        </div>
        
        <div class="card" style="border-top:6px solid var(--route);">
          <div style="display:flex; align-items:center; gap:16px;">
            <i class="fas fa-route" style="font-size:24px; color:var(--route);"></i>
            <div>
              <h3 style="margin:0;">Route Management</h3>
              <p class="mini">Assign drivers for AM/PM</p>
            </div>
          </div>
        </div>
        
        <div class="card" style="border-top:6px solid var(--admin);">
          <div style="display:flex; align-items:center; gap:16px;">
            <i class="fas fa-user-graduate" style="font-size:24px; color:var(--admin);"></i>
            <div>
              <h3 style="margin:0;">Student Management</h3>
              <p class="mini">Enroll and manage students</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily Transport Logs -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h4 style="margin:0;"><i class="fas fa-history"></i> Daily Transport Logs</h4>
          <button class="btn-outline" onclick="window.exportLogs()">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
        <div class="scroll-box">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Student</th>
                <th>AM Pick</th>
                <th>AM Drop</th>
                <th>PM Pick</th>
                <th>PM Drop</th>
              </tr>
            </thead>
            <tbody id="logsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Route Management with Enhanced UI -->
      <div class="card">
        <h4><i class="fas fa-route"></i> Route Management (AM/PM Drivers)</h4>
        <div class="mini" style="margin-bottom:16px;">
          <i class="fas fa-info-circle"></i> Assign different drivers for AM and PM sessions. Route order is set in Student Database using Stop #.
        </div>
        
        <div class="scroll-box">
          <table>
            <thead>
              <tr>
                <th>Route</th>
                <th>Driver (AM)</th>
                <th>Driver (PM)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rtTableBody"></tbody>
          </table>
        </div>

        <form id="regRouteForm" style="display:flex; gap:10px; margin-top:20px;">
          <input type="text" id="rtName" placeholder="Enter new route name" required style="flex:1;">
          <button type="submit" class="btn-route">
            <i class="fas fa-plus-circle"></i> Create Route
          </button>
        </form>
      </div>

      <!-- Driver Registration -->
      <div class="card">
        <h4><i class="fas fa-user-plus"></i> Register New Driver</h4>
        <form id="regDriverForm" class="form-grid">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label class="mini">Full Name</label>
            <input type="text" id="dName" placeholder="e.g., John Smith" required>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label class="mini">Email</label>
            <input type="email" id="dEmail" placeholder="driver@school.com" required>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label class="mini">Phone</label>
            <input type="text" id="dPhone" placeholder="+81 90-1234-5678" required>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label class="mini">Vehicle Details</label>
            <input type="text" id="dCar" placeholder="Toyota Hiace ¬∑ ÂìÅÂ∑ù 300 „ÅÇ 1234" required>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label class="mini">Password</label>
            <input type="password" id="dPass" placeholder="Secure password" required>
          </div>
          <button type="submit" class="btn-ready" style="grid-column:1/-1;">
            <i class="fas fa-user-shield"></i> Register Driver
          </button>
        </form>
      </div>

      <!-- Registered Drivers -->
      <div class="card">
        <h4><i class="fas fa-users"></i> Registered Drivers</h4>
        <div class="scroll-box">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Vehicle</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody id="driverTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Student Enrollment - Enhanced with Multiple Kids Support -->
      <div class="card">
        <h4><i class="fas fa-user-graduate"></i> Student Enrollment</h4>
        <div class="mini" style="margin-bottom:16px;">
          <i class="fas fa-info-circle"></i> You can enroll multiple siblings under one parent account.
        </div>
        
        <div style="margin-bottom:20px;">
          <button onclick="window.toggleMultiStudentForm()" class="btn-outline">
            <i class="fas fa-plus-circle"></i> Add Another Child (Sibling)
          </button>
        </div>

        <form id="regStForm" class="form-grid">
          <!-- Parent Information (Common) -->
          <div style="grid-column:1/-1; background:#f8fafc; padding:16px; border-radius:8px; margin-bottom:8px;">
            <h5 style="margin:0 0 12px 0;"><i class="fas fa-user"></i> Parent/Guardian Information</h5>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
              <input type="text" id="sFather" placeholder="Father's Name">
              <input type="text" id="sFPhone" placeholder="Father's Phone">
              <input type="text" id="sMother" placeholder="Mother's Name">
              <input type="text" id="sMPhone" placeholder="Mother's Phone">
              <select id="sPrimary">
                <option value="Father">Primary: Father</option>
                <option value="Mother">Primary: Mother</option>
              </select>
              <input type="email" id="sPEmail" placeholder="Parent Login Email" required>
              <input type="password" id="sPPass" placeholder="Parent Password" required>
              <input type="text" id="sParentPhone" placeholder="Parent Mobile (for notifications)">
            </div>
          </div>

          <!-- Child 1 Information -->
          <div id="child1Section" style="grid-column:1/-1; border:1px solid #e2e8f0; padding:16px; border-radius:8px;">
            <h5 style="margin:0 0 12px 0;"><i class="fas fa-child"></i> Child 1 Information</h5>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
              <input type="text" id="sName1" placeholder="Student Full Name" required>
              <select id="sGender1">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
              <input type="date" id="sDob1" required>
              <input type="text" id="sAddr1" placeholder="Home Address" required>
              <select id="sRouteSelect1" required>
                <option value="">Select Route...</option>
              </select>
              <div style="display:flex; gap:8px;">
                <input type="text" id="sCustomPickup1" placeholder="Custom Pickup (if different)">
                <button type="button" class="btn-outline" onclick="window.copyAddress('pickup', 1)">Copy Home</button>
              </div>
              <div style="display:flex; gap:8px;">
                <input type="text" id="sCustomDropoff1" placeholder="Custom Dropoff (if different)">
                <button type="button" class="btn-outline" onclick="window.copyAddress('dropoff', 1)">Copy Home</button>
              </div>
            </div>
          </div>

          <!-- Additional Children will be added here -->
          <div id="additionalChildrenContainer"></div>

          <button type="submit" style="background:var(--admin); color:white; grid-column:1/-1; padding:16px;">
            <i class="fas fa-save"></i> Enroll Family
          </button>
        </form>
      </div>

      <!-- Student Database with Editable Locations -->
      <div class="card">
        <h4><i class="fas fa-database"></i> Student Database</h4>
        <div class="mini" style="margin-bottom:16px;">
          <i class="fas fa-info-circle"></i> Click on pickup/dropoff to edit. Stop # = pickup sequence. Use duration presets for quick setup.
        </div>
        
        <div class="scroll-box">
          <table style="min-width:1400px;">
            <thead>
              <tr>
                <th>Student</th>
                <th>Route</th>
                <th>Pickup Location</th>
                <th>Dropoff Location</th>
                <th>Stop #</th>
                <th>AM min</th>
                <th>PM min</th>
                <th>Quick Presets</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="stTableBody"></tbody>
          </table>
        </div>
      </div>
    `;

    // Populate route select
    const rtSelect = document.getElementById('sRouteSelect1');
    rtSelect.innerHTML = '<option value="">Select Route...</option>';
    routesList.forEach(r => {
      rtSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
    });

    // Route table
    const rtBody = document.getElementById('rtTableBody');
    rtBody.innerHTML = "";
    routesList.forEach(r => {
      let drOptionsAM = `<option value="">Unassigned</option>`;
      let drOptionsPM = `<option value="">Unassigned</option>`;

      Object.keys(driverMap).forEach(uid => {
        drOptionsAM += `<option value="${uid}" ${(r.driverUidAM||"") === uid ? "selected" : ""}>${driverMap[uid].fullName}</option>`;
        drOptionsPM += `<option value="${uid}" ${(r.driverUidPM||"") === uid ? "selected" : ""}>${driverMap[uid].fullName}</option>`;
      });

      rtBody.innerHTML += `
        <tr>
          <td><b>${r.name}</b></td>
          <td>
            <select onchange="window.setRouteDriver('${r.id}','AM', this.value)" style="min-width:150px;">
              ${drOptionsAM}
            </select>
          </td>
          <td>
            <select onchange="window.setRouteDriver('${r.id}','PM', this.value)" style="min-width:150px;">
              ${drOptionsPM}
            </select>
          </td>
          <td>
            <button onclick="window.delDoc('routes','${r.id}')" style="color:var(--danger); background:transient;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });

    // Drivers table
    const dtb = document.getElementById("driverTableBody");
    if (dtb) {
      dtb.innerHTML = "";
      Object.values(driverMap).forEach(d => {
        dtb.innerHTML += `<tr>
          <td><b>${escapeHtml(d.fullName || "-")}</b></td>
          <td>${escapeHtml(d.phone || "-")}</td>
          <td>${escapeHtml(d.assignedCar || "-")}</td>
          <td>${escapeHtml(d.email || "-")}</td>
        </tr>`;
      });
    }

    // Logs
    onSnapshot(query(collection(db, "history"), orderBy("timestamp", "desc"), limit(50)), (snap) => {
      const ltb = document.getElementById('logsTableBody');
      if (!ltb) return;
      ltb.innerHTML = "";
      snap.forEach(docSnap => {
        const h = docSnap.data();
        ltb.innerHTML += `<tr>
          <td><small>${h.date || '-'}</small></td>
          <td><strong>${h.studentName || 'Unknown'}</strong></td>
          <td style="color:var(--driver)"><i class="fas fa-check-circle"></i> ${h.morn_pick || '--:--'}</td>
          <td style="color:var(--driver)"><i class="fas fa-flag-checkered"></i> ${h.morn_drop || '--:--'}</td>
          <td style="color:var(--route)"><i class="fas fa-check-circle"></i> ${h.ret_pick || '--:--'}</td>
          <td style="color:var(--route)"><i class="fas fa-home"></i> ${h.ret_drop || '--:--'}</td>
        </tr>`;
      });
    });

    // Student Database with Editable Locations
    onSnapshot(collection(db, "students"), (snap) => {
      const stb = document.getElementById('stTableBody');
      if (!stb) return;
      stb.innerHTML = "";

      snap.forEach(docSnap => {
        const s = docSnap.data();
        const sid = docSnap.id;

        let rtOptions = `<option value="">None</option>`;
        routesList.forEach(r => {
          rtOptions += `<option value="${r.id}" ${s.routeId === r.id ? 'selected' : ''}>${r.name}</option>`;
        });

        stb.innerHTML += `<tr>
          <td>
            <b>${escapeHtml(s.name || "")}</b>
            ${s.status === 'LEAVE' ? '<span class="portal-tag bg-danger" style="margin-left:8px;">LEAVE</span>' : ''}
            <div class="mini">Parent: ${escapeHtml(s.father || s.mother || 'N/A')}</div>
          </td>
          <td><select onchange="window.setStudentRoute('${sid}', this.value)" style="min-width:130px;">${rtOptions}</select></td>
          
          <!-- Editable Pickup Location -->
          <td>
            <div style="display:flex; flex-direction:column; gap:4px;">
              <input type="text" value="${escapeHtml(s.pickupLoc || s.address || '')}" 
                onchange="window.updateStudentLocation('${sid}', 'pickup', this.value)"
                placeholder="Pickup address"
                style="padding:6px; font-size:0.8rem;">
              ${s.pickupLoc !== s.address ? '<span class="mini" style="color:var(--route);">Custom</span>' : ''}
            </div>
          </td>
          
          <!-- Editable Dropoff Location -->
          <td>
            <div style="display:flex; flex-direction:column; gap:4px;">
              <input type="text" value="${escapeHtml(s.dropoffLoc || s.address || '')}" 
                onchange="window.updateStudentLocation('${sid}', 'dropoff', this.value)"
                placeholder="Dropoff address"
                style="padding:6px; font-size:0.8rem;">
              ${s.dropoffLoc !== s.address ? '<span class="mini" style="color:var(--route);">Custom</span>' : ''}
            </div>
          </td>

          <td>
            <input type="number" min="1" step="1" value="${s.stopOrder ?? ""}" style="width:70px;"
              onchange="window.setStudentFieldNumber('${sid}','stopOrder', this.value)" />
            ${typeof s.stopOrder !== "number" ? `<div class="mini danger">Required</div>` : ``}
          </td>

          <td>
            <input type="number" min="0" step="1" value="${s.minsAM ?? ""}" style="width:70px;"
              onchange="window.setStudentFieldNumber('${sid}','minsAM', this.value)" />
          </td>

          <td>
            <input type="number" min="0" step="1" value="${s.minsPM ?? ""}" style="width:70px;"
              onchange="window.setStudentFieldNumber('${sid}','minsPM', this.value)" />
          </td>

          <!-- Quick Duration Presets -->
          <td>
            <div style="display:flex; gap:4px; flex-wrap:wrap;">
              <span class="duration-btn" onclick="window.applyDurationPreset('${sid}', 'AM', 2)">2min</span>
              <span class="duration-btn" onclick="window.applyDurationPreset('${sid}', 'AM', 5)">5min</span>
              <span class="duration-btn" onclick="window.applyDurationPreset('${sid}', 'AM', 10)">10min</span>
              <span class="duration-btn" onclick="window.copyFromActual('${sid}', 'AM')">Copy</span>
            </div>
            <div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px;">
              <span class="duration-btn" onclick="window.applyDurationPreset('${sid}', 'PM', 2)">2min</span>
              <span class="duration-btn" onclick="window.applyDurationPreset('${sid}', 'PM', 5)">5min</span>
              <span class="duration-btn" onclick="window.applyDurationPreset('${sid}', 'PM', 10)">10min</span>
              <span class="duration-btn" onclick="window.copyFromActual('${sid}', 'PM')">Copy</span>
            </div>
          </td>

          <td>
            <button onclick="window.delDoc('students','${sid}')" style="color:var(--danger); background:transparent;">
              <i class="fas fa-user-minus"></i>
            </button>
          </td>
        </tr>`;
      });
    });

    // Multi-student form handling
    window.childCount = 1;
    window.toggleMultiStudentForm = () => {
      window.childCount++;
      const container = document.getElementById('additionalChildrenContainer');
      const newChildSection = document.createElement('div');
      newChildSection.id = `child${window.childCount}Section`;
      newChildSection.style = "grid-column:1/-1; border:1px solid #e2e8f0; padding:16px; border-radius:8px; margin-top:16px;";
      newChildSection.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h5 style="margin:0;"><i class="fas fa-child"></i> Child ${window.childCount} Information</h5>
          <button type="button" onclick="this.closest('div[id^=child]').remove()" style="color:var(--danger); background:none;">
            <i class="fas fa-times-circle"></i> Remove
          </button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
          <input type="text" id="sName${window.childCount}" placeholder="Student Full Name" required>
          <select id="sGender${window.childCount}">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
          <input type="date" id="sDob${window.childCount}" required>
          <input type="text" id="sAddr${window.childCount}" placeholder="Home Address" required>
          <select id="sRouteSelect${window.childCount}" required>
            <option value="">Select Route...</option>
            ${routesList.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
          </select>
          <div style="display:flex; gap:8px;">
            <input type="text" id="sCustomPickup${window.childCount}" placeholder="Custom Pickup">
            <button type="button" class="btn-outline" onclick="window.copyAddress('pickup', ${window.childCount})">Copy</button>
          </div>
          <div style="display:flex; gap:8px;">
            <input type="text" id="sCustomDropoff${window.childCount}" placeholder="Custom Dropoff">
            <button type="button" class="btn-outline" onclick="window.copyAddress('dropoff', ${window.childCount})">Copy</button>
          </div>
        </div>
      `;
      container.appendChild(newChildSection);
    };

    // Copy home address helper
    window.copyAddress = (type, childNum) => {
      const addrEl = document.getElementById(`sAddr${childNum}`);
      if (!addrEl) return;
      
      if (type === 'pickup') {
        document.getElementById(`sCustomPickup${childNum}`).value = addrEl.value;
      } else {
        document.getElementById(`sCustomDropoff${childNum}`).value = addrEl.value;
      }
    };

    // Form submission for multiple kids
    document.getElementById('regStForm').onsubmit = async (e) => {
      e.preventDefault();
      
      try {
        const students = [];
        
        // Collect Child 1 data
        students.push({
          tempId: `temp_${Date.now()}_1`,
          name: sName1.value,
          gender: sGender1.value,
          dob: sDob1.value,
          address: sAddr1.value,
          routeId: sRouteSelect1.value,
          pickupLoc: sCustomPickup1.value || sAddr1.value,
          dropoffLoc: sCustomDropoff1.value || sAddr1.value,
          relation: 'Child'
        });
        
        // Collect additional children
        for (let i = 2; i <= window.childCount; i++) {
          const nameEl = document.getElementById(`sName${i}`);
          if (nameEl && nameEl.value) {
            students.push({
              tempId: `temp_${Date.now()}_${i}`,
              name: nameEl.value,
              gender: document.getElementById(`sGender${i}`).value,
              dob: document.getElementById(`sDob${i}`).value,
              address: document.getElementById(`sAddr${i}`).value,
              routeId: document.getElementById(`sRouteSelect${i}`).value,
              pickupLoc: document.getElementById(`sCustomPickup${i}`)?.value || document.getElementById(`sAddr${i}`).value,
              dropoffLoc: document.getElementById(`sCustomDropoff${i}`)?.value || document.getElementById(`sAddr${i}`).value,
              relation: 'Child'
            });
          }
        }
        
        // Register parent with multiple kids
        await registerParentWithKids({
          email: sPEmail.value,
          password: sPPass.value,
          fullName: `${sFather.value || sMother.value || 'Parent'}`,
          phone: sParentPhone.value || sFPhone.value || sMPhone.value
        }, students);
        
        alert(`Successfully enrolled ${students.length} student(s)!`);
        e.target.reset();
        window.childCount = 1;
        document.getElementById('additionalChildrenContainer').innerHTML = '';
        
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    // Create route
    document.getElementById('regRouteForm').onsubmit = async (e) => {
      e.preventDefault();
      await addDoc(collection(db, "routes"), {
        name: rtName.value,
        driverUidAM: "",
        driverUidPM: "",
        createdAt: serverTimestamp()
      });
      e.target.reset();
      alert('Route created!');
    };

    // Register driver
    document.getElementById('regDriverForm').onsubmit = async (e) => {
      e.preventDefault();
      try {
        const cred = await createUserWithEmailAndPassword(secAuth, dEmail.value, dPass.value);
        await addDoc(collection(db, "users"), {
          uid: cred.user.uid,
          fullName: dName.value,
          email: dEmail.value,
          role: "driver",
          phone: dPhone.value,
          assignedCar: dCar.value,
          createdAt: serverTimestamp()
        });
        await signOut(secAuth);
        alert("Driver Registered Successfully!");
        e.target.reset();
      } catch (err) {
        alert(err.message);
      }
    };
  }

  // ============== DRIVER VIEW (Enhanced - User Friendly) ==============
  function renderDriver(target, uid) {
    const assigned = routesList
      .map(r => {
        const am = (r.driverUidAM || "") === uid;
        const pm = (r.driverUidPM || "") === uid;
        const sessions = [];
        if (am) sessions.push("AM");
        if (pm) sessions.push("PM");
        return sessions.length ? { route: r, sessions } : null;
      })
      .filter(Boolean);

    if (assigned.length === 0) {
      target.innerHTML = `
        <div class="card" style="text-align:center; padding:40px;">
          <i class="fas fa-exclamation-circle" style="font-size:48px; color:var(--logs); margin-bottom:16px;"></i>
          <h3>No Route Assigned</h3>
          <p class="mini">Please contact the administrator to assign you a route.</p>
        </div>
      `;
      return;
    }

    let unsubTrip = null;
    let unsubOverrides = null;
    let unsubStudents = null;
    
    const clearDriverSubs = () => {
      if (unsubTrip) { unsubTrip(); unsubTrip = null; }
      if (unsubOverrides) { unsubOverrides(); unsubOverrides = null; }
      if (unsubStudents) { unsubStudents(); unsubStudents = null; }
    };

    target.innerHTML = `
      <div class="card" style="border-top:6px solid var(--driver);">
        <!-- Header with Quick Actions -->
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:20px;">
          <div>
            <h2 style="margin:0;"><i class="fas fa-bus"></i> Driver Console</h2>
            <div class="mini" style="margin-top:4px;">
              <i class="fas fa-calendar"></i> ${todayISO()} 
              <span id="currentTime" style="margin-left:12px;"></span>
            </div>
          </div>
          
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <select id="drvRoute" class="btn-outline" style="padding:12px; min-width:200px;">
              ${assigned.map(x => `<option value="${x.route.id}">${escapeHtml(x.route.name)}</option>`).join("")}
            </select>
            
            <select id="drvSession" class="btn-outline" style="padding:12px; min-width:120px;"></select>
            
            <button class="btn-ready" onclick="window.startTripNow('${uid}')">
              <i class="fas fa-play"></i> Start Trip
            </button>
            
            <button class="btn-gray" onclick="window.endTripNow('${uid}')" style="background:#475569;">
              <i class="fas fa-stop"></i> End Trip
            </button>
          </div>
        </div>

        <!-- Trip Status Card -->
        <div style="background:#f0fdf4; border-radius:16px; padding:16px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
          <div style="display:flex; align-items:center; gap:16px;">
            <span class="portal-tag bg-driver" style="padding:8px 20px;">TRIP</span>
            <div>
              <span id="tripBadge" style="font-weight:700; font-size:1.1rem;">Not Started</span>
              <span id="tripState" class="mini" style="margin-left:8px;"></span>
            </div>
          </div>
          
          <!-- Progress Bar -->
          <div style="flex:1; max-width:300px; margin-left:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
              <span class="mini">Route Progress</span>
              <span class="mini" id="progressPercent">0%</span>
            </div>
            <div class="progress-container">
              <div id="progressBar" class="progress-bar" style="width:0%;"></div>
            </div>
          </div>
        </div>

        <!-- Voice Assistant Quick Tip -->
        <div class="mini" style="background:#fff3cd; padding:12px; border-radius:12px; margin-bottom:20px;">
          <i class="fas fa-microphone"></i> Quick Tip: Click the üó∫Ô∏è Map button to navigate to student location
        </div>

        <!-- Students List -->
        <div id="dList" style="display:flex; flex-direction:column; gap:16px;"></div>
      </div>
    `;

    // Update current time
    setInterval(() => {
      const timeEl = document.getElementById('currentTime');
      if (timeEl) timeEl.innerText = new Date().toLocaleTimeString();
    }, 1000);

    const setSessionOptions = () => {
      const rid = document.getElementById("drvRoute").value;
      const item = assigned.find(x => x.route.id === rid);
      const sSel = document.getElementById("drvSession");
      sSel.innerHTML = item.sessions.map(s => 
        `<option value="${s}">${s} Trip ${s === 'AM' ? '‚òÄÔ∏è' : 'üåô'}</option>`
      ).join("");

      const preferred = item.sessions.includes(defaultSession()) ? defaultSession() : item.sessions[0];
      sSel.value = preferred;
    };

    const refreshDriverView = () => {
      const routeId = document.getElementById('drvRoute').value;
      const session = document.getElementById('drvSession').value;
      const tid = tripIdFor(routeId, todayISO(), session);
      
      document.getElementById('tripBadge').innerText = tid;
      let tripStartHM = null;
      let overridesMap = {};
      
      clearDriverSubs();

      // Trip doc
      unsubTrip = onSnapshot(doc(db, "trips", tid), (snap) => {
        const el = document.getElementById('tripState');
        if (el) {
          if (snap.exists()) {
            const data = snap.data();
            el.innerText = `(${data.status || "LIVE"}) Started at ${data.tripStartHM || '--:--'}`;
            tripStartHM = data.tripStartHM || null;
          } else {
            el.innerText = "(Not started - click Start Trip)";
          }
        }
      });

      // Overrides
      unsubOverrides = onSnapshot(collection(db, "trips", tid, "overrides"), (oSnap) => {
        overridesMap = {};
        oSnap.forEach(d => {
          const data = d.data();
          overridesMap[d.id] = data?.mins ?? null;
        });
      });

      // Students list with enhanced UI
      unsubStudents = onSnapshot(
        query(collection(db, "students"), where("routeId", "==", routeId)),
        (snap) => {
          const list = document.getElementById('dList');
          list.innerHTML = "";

          const docs = snap.docs
            .map(d => ({ id: d.id, ...d.data() }))
            .filter(s => s.stopOrder != null) // Only show students with stop order
            .sort((a,b) => (a.stopOrder ?? 9999) - (b.stopOrder ?? 9999));

          // Calculate progress
          const completedStops = docs.filter(s => 
            session === "AM" ? s.doneAM : s.donePM
          ).length;
          
          const progress = docs.length ? Math.round((completedStops / docs.length) * 100) : 0;
          const progressBar = document.getElementById('progressBar');
          const progressPercent = document.getElementById('progressPercent');
          if (progressBar) progressBar.style.width = `${progress}%`;
          if (progressPercent) progressPercent.innerText = `${progress}%`;

          docs.forEach((st, index) => {
            const sid = st.id;
            const isLeave = st.status === "LEAVE";
            const isDone = session === "AM" ? st.doneAM : st.donePM;
            const isNext = !isDone && !isLeave && index === completedStops;
            
            const pickup = st.pickupLoc || st.address || "";
            const dropoff = st.dropoffLoc || st.address || "";
            const eta = tripStartHM
              ? computeEtaForStudentFromDocs(session, sid, tripStartHM, snap.docs, overridesMap)
              : "--:--";

            const field = (session === "AM") ? "minsAM" : "minsPM";
            const baseMins = parseInt(st[field] ?? "0", 10);
            const overrideMins = overridesMap?.[sid];
            const minsValue = (overrideMins !== undefined && overrideMins !== null)
              ? overrideMins
              : (Number.isFinite(baseMins) ? baseMins : 0);

            list.innerHTML += `
              <div class="driver-student-card ${isLeave ? 'leave' : ''} ${isNext ? 'next-stop' : ''}" 
                   style="${isDone ? 'opacity:0.7; background:#f8fafc;' : ''}">
                
                <!-- Header Row -->
                <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;">
                  <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <span class="stop-badge">#${st.stopOrder}</span>
                    <div>
                      <strong style="font-size:1.1rem;">${escapeHtml(st.name || "")}</strong>
                      ${isLeave ? '<span class="portal-tag bg-danger">ON LEAVE</span>' : ''}
                      ${isDone ? '<span class="portal-tag bg-done">COMPLETED</span>' : ''}
                      ${isNext && !isLeave && !isDone ? '<span class="portal-tag bg-warning" style="background:var(--warning);">NEXT STOP</span>' : ''}
                    </div>
                  </div>
                  
                  <div style="display:flex; gap:12px;">
                    <div class="chip" style="background:${isNext ? '#fffbeb' : 'white'};">
                      <i class="fas fa-clock"></i> ETA: <b>${eta}</b>
                    </div>
                  </div>
                </div>

                <!-- Location Info -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0; background:#f8fafc; padding:12px; border-radius:12px;">
                  <div>
                    <span class="mini"><i class="fas fa-map-marker-alt"></i> PICKUP</span>
                    <div style="font-size:0.9rem;">${escapeHtml(pickup)}</div>
                  </div>
                  <div>
                    <span class="mini"><i class="fas fa-flag-checkered"></i> DROPOFF</span>
                    <div style="font-size:0.9rem;">${escapeHtml(dropoff)}</div>
                  </div>
                </div>

                <!-- Duration Control -->
                <div style="display:flex; align-items:center; gap:16px; margin:12px 0; flex-wrap:wrap;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-hourglass-half"></i>
                    <span class="mini">Stop Duration:</span>
                  </div>
                  
                  <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <span class="duration-btn" onclick="window.updateStopMins('${routeId}','${session}','${sid}', 2)">2min</span>
                    <span class="duration-btn" onclick="window.updateStopMins('${routeId}','${session}','${sid}', 5)">5min</span>
                    <span class="duration-btn" onclick="window.updateStopMins('${routeId}','${session}','${sid}', 10)">10min</span>
                    <span class="duration-btn" onclick="window.updateStopMins('${routeId}','${session}','${sid}', 15)">15min</span>
                    
                    <input class="small-input" type="number" min="0" step="1" 
                           value="${minsValue}" 
                           onchange="window.updateStopMins('${routeId}','${session}','${sid}', this.value)" 
                           style="width:70px; padding:6px;"
                           placeholder="Custom">
                    
                    <button class="btn-outline" onclick="window.clearStopMins('${routeId}','${session}','${sid}')" 
                            style="padding:6px 12px;">
                      <i class="fas fa-undo"></i>
                    </button>
                  </div>
                </div>

                ${!isLeave ? `
                  <!-- Action Buttons -->
                  <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:12px;">
                    <button class="btn-outline" onclick="window.openMapTo('${escapeHtml(pickup)}')" 
                            style="${isNext ? 'background:var(--route); color:white; border-color:var(--route);' : ''}">
                      <i class="fas fa-map"></i> Navigate
                    </button>
                    
                    ${session === "AM" ? `
                      <button id="${btnId(sid,'morn_pick')}" class="${isDone ? 'btn-done' : 'btn-ready'}" 
                              onclick="window.markEvent('${routeId}','${uid}','AM','${sid}','${escapeHtml(st.name)}','PICKED_AM','morn_pick')"
                              ${isDone ? 'disabled' : ''}>
                        <i class="fas fa-user-check"></i> ${isDone ? 'Picked Up' : 'Pickup'}
                      </button>
                      
                      <button id="${btnId(sid,'morn_drop')}" class="${isDone ? 'btn-done' : 'btn-ready'}" 
                              onclick="window.markEvent('${routeId}','${uid}','AM','${sid}','${escapeHtml(st.name)}','DROPPED_SCHOOL_AM','morn_drop')"
                              ${isDone ? 'disabled' : ''}>
                        <i class="fas fa-school"></i> ${isDone ? 'Dropped' : 'Drop at School'}
                      </button>
                    ` : `
                      <button id="${btnId(sid,'ret_pick')}" class="${isDone ? 'btn-done' : 'btn-ready'}" 
                              onclick="window.markEvent('${routeId}','${uid}','PM','${sid}','${escapeHtml(st.name)}','PICKED_SCHOOL_PM','ret_pick')"
                              ${isDone ? 'disabled' : ''}>
                        <i class="fas fa-school"></i> ${isDone ? 'Picked' : 'Pick from School'}
                      </button>
                      
                      <button id="${btnId(sid,'ret_drop')}" class="${isDone ? 'btn-done' : 'btn-ready'}" 
                              onclick="window.markEvent('${routeId}','${uid}','PM','${sid}','${escapeHtml(st.name)}','DROPPED_PM','ret_drop')"
                              ${isDone ? 'disabled' : ''}>
                        <i class="fas fa-home"></i> ${isDone ? 'Dropped' : 'Drop Home'}
                      </button>
                    `}
                  </div>
                ` : `
                  <div style="background:#fee2e2; padding:12px; border-radius:12px; margin-top:12px;">
                    <i class="fas fa-exclamation-triangle" style="color:var(--danger);"></i>
                    Student is on leave today. No actions required.
                  </div>
                `}
              </div>
            `;
          });
        }
      );
    };

    document.getElementById("drvRoute").onchange = () => { setSessionOptions(); refreshDriverView(); };
    document.getElementById("drvSession").onchange = refreshDriverView;

    setSessionOptions();
    refreshDriverView();
  }

  // ============== PARENT VIEW (Enhanced - Multiple Kids + Auto Refresh) ==============
  function renderParent(target, uid) {
    target.innerHTML = `
      <div id="parentDashboard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h2><i class="fas fa-users"></i> My Children</h2>
          <div class="status-chip">
            <i class="fas fa-bell"></i> Notifications: <span id="notificationBadge">0</span>
          </div>
        </div>
        
        <!-- Child Selector -->
        <div id="childSelector" class="child-selector"></div>
        
        <!-- Child Details Container -->
        <div id="childDetailsContainer"></div>
        
        <!-- Notification Center -->
        <div class="card" style="margin-top:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4><i class="fas fa-bell"></i> Recent Notifications</h4>
            <button class="btn-outline" onclick="window.markAllNotificationsRead()">
              <i class="fas fa-check-double"></i> Mark all read
            </button>
          </div>
          <div id="notificationList" style="max-height:300px; overflow-y:auto; margin-top:16px;"></div>
        </div>
      </div>
    `;

    // Get all children for this parent
    onSnapshot(query(collection(db, "students"), where("parentUid", "==", uid)), (snap) => {
      const children = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      if (children.length === 0) {
        target.innerHTML = `<div class="card"><h4>No students assigned to this parent account.</h4></div>`;
        return;
      }

      // Store in global for access
      parentStudentsMap[uid] = children;

      // Build child selector
      const selector = document.getElementById('childSelector');
      selector.innerHTML = children.map((child, index) => `
        <div class="child-tab ${index === 0 ? 'active' : ''}" 
             onclick="window.selectChild('${child.id}', this)">
          <i class="fas fa-child"></i> ${escapeHtml(child.name || 'Child')}
          ${child.status === 'LEAVE' ? '<span style="margin-left:6px;">üö´</span>' : ''}
        </div>
      `).join('');

      // Show first child by default
      if (children.length > 0) {
        window.selectChild(children[0].id, selector.children[0]);
      }

      // Load notifications
      loadParentNotifications(uid);
    });

    // Load notifications
    async function loadParentNotifications(parentUid) {
      onSnapshot(
        query(collection(db, "notifications"), where("uid", "==", parentUid), orderBy("timestamp", "desc"), limit(20)),
        (snap) => {
          const notifList = document.getElementById('notificationList');
          const badge = document.getElementById('notificationBadge');
          
          const unread = snap.docs.filter(d => !d.data().read).length;
          if (badge) badge.innerText = unread;
          
          if (notifList) {
            notifList.innerHTML = snap.docs.map(d => {
              const notif = d.data();
              const time = notif.timestamp?.toDate();
              return `
                <div style="padding:12px; border-bottom:1px solid #edf2f7; ${!notif.read ? 'background:#f0f9ff;' : ''}">
                  <div style="display:flex; justify-content:space-between;">
                    <strong>${escapeHtml(notif.title || 'Update')}</strong>
                    <span class="mini">${time ? time.toLocaleTimeString() : ''}</span>
                  </div>
                  <div style="margin-top:4px;">${escapeHtml(notif.body || '')}</div>
                  ${!notif.read ? `
                    <button onclick="window.markNotificationRead('${d.id}')" style="margin-top:8px; padding:4px 12px;" class="btn-outline">
                      Mark read
                    </button>
                  ` : ''}
                </div>
              `;
            }).join('');
          }
        }
      );
    }

    // Child selection function
    window.selectChild = (studentId, element) => {
      // Update active tab
      document.querySelectorAll('.child-tab').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      
      // Find child data
      const child = parentStudentsMap[uid].find(c => c.id === studentId);
      if (!child) return;
      
      renderChildDetails(child);
    };

    // Render individual child details
    function renderChildDetails(child) {
      const container = document.getElementById('childDetailsContainer');
      const sid = child.id;
      const route = routesList.find(r => r.id === child.routeId);
      
      let unsubs = [];
      const clearParentSubs = () => { unsubs.forEach(u => u()); unsubs = []; };
      
      container.innerHTML = `
        <div class="parent-child-card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
              <h3 style="margin:0;">${escapeHtml(child.name || "")}</h3>
              <span class="mini">Grade/Class: ${escapeHtml(child.grade || 'Not specified')}</span>
            </div>
            <div style="display:flex; gap:12px;">
              <div class="status-chip">
                <i class="fas fa-route"></i> ${route ? escapeHtml(route.name) : 'No Route'}
              </div>
              <select id="pSess_${sid}" style="padding:8px 16px; border-radius:30px;">
                <option value="AM" ${defaultSession()==="AM"?"selected":""}>‚òÄÔ∏è AM Trip</option>
                <option value="PM" ${defaultSession()==="PM"?"selected":""}>üåô PM Trip</option>
              </select>
            </div>
          </div>

          <!-- Live Status Card -->
          <div style="background:linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); padding:20px; border-radius:20px; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
              <div>
                <span class="mini">CURRENT STATUS</span>
                <h2 style="margin:8px 0; color:${child.status === 'LEAVE' ? 'var(--danger)' : 'var(--parent)'}">
                  ${child.status === 'LEAVE' ? 'üö´ On Leave' : (child.status || 'AWAITING')}
                </h2>
              </div>
              <div style="display:flex; gap:20px;">
                <div style="text-align:center;">
                  <span class="mini">ETA</span>
                  <div style="font-size:1.8rem; font-weight:700;" id="eta_${sid}">--:--</div>
                </div>
                <div style="text-align:center;">
                  <span class="mini">TRIP</span>
                  <div style="font-size:1.2rem; font-weight:600;" id="tripState_${sid}">Not started</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Location Info -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
            <div style="background:#f8fafc; padding:16px; border-radius:16px;">
              <span class="mini"><i class="fas fa-map-marker-alt"></i> PICKUP LOCATION</span>
              <div style="margin-top:8px; font-size:1rem;">${escapeHtml(child.pickupLoc || child.address || '-')}</div>
              ${child.pickupLoc !== child.address ? '<span class="mini" style="color:var(--route);">Custom pickup location</span>' : ''}
            </div>
            <div style="background:#f8fafc; padding:16px; border-radius:16px;">
              <span class="mini"><i class="fas fa-flag-checkered"></i> DROPOFF LOCATION</span>
              <div style="margin-top:8px; font-size:1rem;">${escapeHtml(child.dropoffLoc || child.address || '-')}</div>
              ${child.dropoffLoc !== child.address ? '<span class="mini" style="color:var(--route);">Custom dropoff location</span>' : ''}
            </div>
          </div>

          <!-- Driver Info -->
          <div style="display:flex; gap:20px; padding:16px; background:#f1f5f9; border-radius:16px; margin-bottom:20px;">
            <div><i class="fas fa-user"></i> Driver: <b id="drv_${sid}">Loading...</b></div>
            <div><i class="fas fa-car"></i> Vehicle: <b id="car_${sid}">Loading...</b></div>
          </div>

          <!-- Quick Actions -->
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="btn-outline" onclick="window.requestLeave('${sid}')">
              <i class="fas fa-calendar-times"></i> Apply Leave
            </button>
            <button class="btn-outline" onclick="window.requestCustomPickup('${sid}')">
              <i class="fas fa-map-pin"></i> Request Change
            </button>
          </div>
        </div>
      `;

      // Bind real-time updates
      const bindParentTrip = (session) => {
        clearParentSubs();
        if (!route) return;

        const driverUid = (session === "AM" ? route.driverUidAM : route.driverUidPM) || "";
        const d = driverUid ? (driverMap[driverUid] || {}) : {};
        const drvEl = document.getElementById(`drv_${sid}`);
        const carEl = document.getElementById(`car_${sid}`);
        if (drvEl) drvEl.innerText = `${d.fullName || "Unassigned"} (${d.phone || "-"})`;
        if (carEl) carEl.innerText = d.assignedCar || "-";

        const tripId = tripIdFor(route.id, todayISO(), session);
        let overridesMap = {};

        unsubs.push(onSnapshot(collection(db, "trips", tripId, "overrides"), (oSnap) => {
          overridesMap = {};
          oSnap.forEach(d => { overridesMap[d.id] = d.data()?.mins ?? null; });
        }));

        unsubs.push(onSnapshot(doc(db, "trips", tripId), (tSnap) => {
          const stateEl = document.getElementById(`tripState_${sid}`);
          const etaEl = document.getElementById(`eta_${sid}`);
          if (!stateEl || !etaEl) return;

          if (!tSnap.exists()) {
            stateEl.innerText = "Not started";
            etaEl.innerText = "--:--";
            return;
          }

          const trip = tSnap.data();
          stateEl.innerText = trip.status || "LIVE";

          const startHM = trip.tripStartHM;
          if (!startHM) { etaEl.innerText = "--:--"; return; }

          unsubs.push(onSnapshot(
            query(collection(db, "students"), where("routeId", "==", route.id)),
            (stSnap) => {
              const eta = computeEtaForStudentFromDocs(session, sid, startHM, stSnap.docs, overridesMap);
              const e = document.getElementById(`eta_${sid}`);
              if (e) e.innerText = eta;
            }
          ));
        }));
      };

      const sel = document.getElementById(`pSess_${sid}`);
      bindParentTrip(sel.value);
      sel.onchange = () => bindParentTrip(sel.value);
    }
  }

  // ============== GLOBAL ACTIONS ==============
  window.handleLogout = () => signOut(auth);
  
  window.handleRefresh = () => {
    updateLastRefreshTime();
    // Force re-render of current view
    const user = auth.currentUser;
    if (user) {
      const q = query(collection(db, "users"), where("uid", "==", user.uid));
      getDocs(q).then(snap => {
        if (!snap.empty) {
          initDashboard(snap.docs[0].data());
        }
      });
    }
  };

  window.resetAllStudents = async () => {
    if (!confirm("‚ö†Ô∏è This will clear all statuses and leave requests for ALL students. This action cannot be undone. Proceed?")) return;
    const batch = writeBatch(db);
    const snap = await getDocs(collection(db, "students"));
    snap.forEach(d => batch.update(d.ref, { 
      status: "AWAITING", 
      doneAM: false, 
      donePM: false,
      updatedAt: serverTimestamp()
    }));
    await batch.commit();
    alert("‚úÖ System reset complete! Ready for new day.");
  };

  window.updateStudentLocation = async (sid, type, address) => {
    if (!address) return alert("Address cannot be empty");
    await updateStudentLocation(sid, type, address);
    alert(`${type === 'pickup' ? 'Pickup' : 'Dropoff'} location updated!`);
  };

  window.updateStopMins = async (routeId, session, sid, val) => {
    const v = val === "" ? null : parseInt(val, 10);
    if (v != null && (!Number.isFinite(v) || v < 0)) return alert("Invalid minutes");
    await setTripOverride(routeId, session, sid, v);
  };

  window.clearStopMins = async (routeId, session, sid) => {
    await setTripOverride(routeId, session, sid, null);
  };

  window.requestLeave = async (sid) => {
    if (confirm("Notify driver that student will be on leave today?")) {
      await updateDoc(doc(db, "students", sid), { 
        status: "LEAVE",
        leaveAppliedAt: serverTimestamp()
      });
      
      // Notify parent
      const student = await getDoc(doc(db, "students", sid));
      if (student.exists() && student.data().parentUid) {
        await sendPushNotification(
          student.data().parentUid,
          "üìÖ Leave Request Submitted",
          `Leave request for ${student.data().name} has been submitted successfully.`
        );
      }
      
      alert("Leave request submitted!");
    }
  };

  window.requestCustomPickup = async (sid) => {
    const newLocation = prompt("Enter special pickup/dropoff location for today:");
    if (newLocation) {
      // Store temporary override
      await setDoc(doc(db, "students", sid, "overrides", todayISO()), {
        pickupLoc: newLocation,
        requestedAt: serverTimestamp(),
        approved: false
      });
      
      alert("Custom location request submitted for approval!");
    }
  };

  window.setRouteDriver = async (routeId, session, driverUid) => {
    const field = session === "AM" ? "driverUidAM" : "driverUidPM";
    await updateDoc(doc(db, "routes", routeId), { [field]: driverUid });
  };

  window.setStudentRoute = async (sid, routeId) => {
    await updateDoc(doc(db, "students", sid), { routeId });
  };

  window.setStudentFieldNumber = async (sid, field, val) => {
    const v = val === "" ? null : parseInt(val, 10);
    if (v != null && (!Number.isFinite(v) || v < 0)) return alert("Invalid number");
    await updateDoc(doc(db, "students", sid), { [field]: v });
  };

  window.startTripNow = async (driverUid) => {
    const routeId = document.getElementById('drvRoute')?.value;
    const session = document.getElementById('drvSession')?.value || defaultSession();
    if (!routeId) return alert("No route selected");

    const startHM = prompt("Enter trip start time (HH:MM)", nowHM());
    if (startHM === null) return;
    if (hmToMinutes(startHM) === null) return alert("Invalid time. Use HH:MM format (e.g., 08:15)");

    try {
      await ensureTrip(routeId, driverUid, session, startHM);
      alert(`üöê Trip started (${session}) at ${startHM}`);
    } catch (e) {
      alert("Failed to start trip: " + e.message);
    }
  };

  window.endTripNow = async (driverUid) => {
    const routeId = document.getElementById('drvRoute')?.value;
    const session = document.getElementById('drvSession')?.value || defaultSession();
    if (!routeId) return alert("No route selected");
    
    if (!confirm(`End ${session} trip for this route?`)) return;
    
    try {
      const tid = tripIdFor(routeId, todayISO(), session);
      await updateDoc(doc(db, "trips", tid), {
        status: "ENDED",
        endedAt: serverTimestamp()
      });
      
      await addDoc(collection(db, "trips", tid, "events"), {
        type: "BUS_ENDED",
        timestamp: serverTimestamp(),
        routeId, driverUid, session
      });
      
      alert(`üèÅ Trip ended (${session})`);
    } catch (e) {
      alert("Failed to end trip: " + e.message);
    }
  };

  window.markEvent = async (routeId, driverUid, session, sid, sName, eventType, historyField) => {
    const today = todayISO();
    const timeStr = timeHMNow();

    // Update student status
    await updateDoc(doc(db, "students", sid), { 
      status: historyField.replace('_', ' ').toUpperCase(),
      updatedAt: serverTimestamp()
    });
    
    // Mark as done
    const donePatch = {};
    if (historyField === "morn_drop") donePatch.doneAM = true;
    if (historyField === "ret_drop") donePatch.donePM = true;
    if (Object.keys(donePatch).length) {
      await updateDoc(doc(db, "students", sid), donePatch);
    }

    // Update history
    await setDoc(doc(db, "history", `${sid}_${today}`), {
      date: today,
      studentName: sName,
      [historyField]: timeStr,
      timestamp: serverTimestamp()
    }, { merge: true });

    // Ensure trip exists
    const tRef = doc(db, "trips", tripIdFor(routeId, todayISO(), session));
    await setDoc(tRef, {
      routeId, driverUid, date: todayISO(), session,
      status: "LIVE",
      tripStartHM: nowHM(),
      startedAt: serverTimestamp()
    }, { merge: true });

    // Add event (this will trigger push notifications)
    await addStudentEvent(routeId, driverUid, session, sid, sName, eventType, { timeStr });

    // Update button UI
    const b = document.getElementById(btnId(sid, historyField));
    if (b) { 
      b.classList.add("btn-done"); 
      b.disabled = true; 
      b.innerHTML = `<i class="fas fa-check"></i> DONE`; 
    }
  };

  window.delDoc = async (c, id) => { 
    if (confirm("Delete this item? This action cannot be undone.")) 
      await deleteDoc(doc(db, c, id)); 
  };

  window.openMapTo = (destination) => {
    if (!destination) return alert("No destination found");
    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}&travelmode=driving`;
    window.open(url, "_blank");
  };

  window.exportLogs = () => {
    alert("Export functionality would connect to your backend server");
    // In production, call your server endpoint to generate CSV/PDF
  };

  window.markNotificationRead = async (notifId) => {
    await updateDoc(doc(db, "notifications", notifId), { read: true });
  };

  window.markAllNotificationsRead = async () => {
    const user = auth.currentUser;
    if (!user) return;
    
    const q = query(collection(db, "notifications"), where("uid", "==", user.uid), where("read", "==", false));
    const snap = await getDocs(q);
    
    const batch = writeBatch(db);
    snap.forEach(d => batch.update(d.ref, { read: true }));
    await batch.commit();
  };

  // Apply duration preset globally
  window.applyDurationPreset = applyDurationPreset;
  window.copyFromActual = copyFromActual;
  
  // Set up auto-refresh timer (every 30 seconds)
  setInterval(() => {
    updateLastRefreshTime();
    // Silent refresh - listeners will update data automatically
  }, 30000);

  // Update connection status
  setInterval(() => {
    const statusEl = document.getElementById('statusText');
    if (statusEl) {
      statusEl.innerText = navigator.onLine ? 'Connected' : 'Offline';
      statusEl.style.color = navigator.onLine ? 'var(--driver)' : 'var(--danger)';
    }
  }, 5000);
</script>

</body>
</html>
