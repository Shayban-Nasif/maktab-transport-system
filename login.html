<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - RS Transport Solution</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .branding h1 { color: #1a73e8; margin-bottom: 5px; }
        .branding p { color: #555; margin-bottom: 30px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; outline-color: #1a73e8; }
        button { background-color: #1a73e8; color: white; border: none; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button:hover { background-color: #1557b0; }
        #errorMessage { color: #d32f2f; font-size: 0.9em; margin-top: 15px; min-height: 1.2em; }
        .back-home { display: block; margin-top: 20px; color: #666; text-decoration: none; font-size: 0.9em; }
        .back-home:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="login-card">
    <div class="branding">
        <h1>RS Transport</h1>
        <p>Iqra International School Tokyo</p>
    </div>

    <form id="loginForm">
        <input type="email" id="email" placeholder="Email Address" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit" id="loginBtn">Sign In</button>
    </form>
    
    <div id="errorMessage"></div>
    <a href="index.html" class="back-home">‚Üê Back to Homepage</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCS163x5b5-MJXxJGwbjE0IlO7R58CkJMg",
        authDomain: "maktab-transport.firebaseapp.com",
        projectId: "maktab-transport",
        storageBucket: "maktab-transport.firebasestorage.app",
        messagingSenderId: "575357634901",
        appId: "1:575357634901:web:4918fb77b0c21965af07dc"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('errorMessage');
        const loginBtn = document.getElementById('loginBtn');

        // Disable button and show loading state
        loginBtn.disabled = true;
        loginBtn.innerText = "Signing in...";
        errorDiv.innerText = "";

        try {
            // 1. Sign in with Firebase Auth
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Fetch User Role from Firestore
            const q = query(collection(db, "users"), where("uid", "==", user.uid));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const userData = querySnapshot.docs[0].data();
                const role = userData.role;

                // 3. Redirect based on role (Added Admin check)
                if (role === 'admin') {
                    window.location.href = "admin.html";
                } else if (role === 'driver') {
                    window.location.href = "driver.html";
                } else if (role === 'parent') {
                    window.location.href = "parent.html";
                } else {
                    errorDiv.innerText = "Access Denied: Unrecognized role.";
                }
            } else {
                errorDiv.innerText = "User profile not found. Please contact Admin.";
            }

        } catch (error) {
            console.error("Login Error:", error);
            // Translate common Firebase errors for users
            if (error.code === 'auth/invalid-credential') {
                errorDiv.innerText = "Incorrect email or password.";
            } else {
                errorDiv.innerText = "Login failed. Please try again.";
            }
        } finally {
            loginBtn.disabled = false;
            loginBtn.innerText = "Sign In";
        }
    });
</script>
</body>
</html>
