<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Route - RS Transport</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; padding: 15px; margin: 0; }
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .student-card { background: #2d2d2d; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #28a745; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .student-card h3 { margin: 0 0 10px 0; color: #fff; }
        .student-card p { margin: 5px 0; color: #bbb; font-size: 0.9em; }
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-home { background: #333; color: #fff; text-decoration: none; font-size: 0.8em; padding: 8px 15px; border-radius: 20px; }
        #status-msg { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="nav">
        <h2>My Daily Route</h2>
        <a href="index.html" class="btn-home">‚Üê Home</a>
    </div>

    <div id="routeList">
        <p>Checking assigned students...</p>
    </div>

<script type="module">
    // 1. CLEANED IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. FIREBASE INITIALIZATION
    const firebaseConfig = { 
        apiKey: "AIzaSyCS163x5b5-MJXxJGwbjE0IlO7R58CkJMg",
        authDomain: "maktab-transport.firebaseapp.com",
        projectId: "maktab-transport",
        storageBucket: "maktab-transport.firebasestorage.app",
        messagingSenderId: "575357634901",
        appId: "1:575357634901:web:4918fb77b0c21965af07dc"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 3. AUTH & DATA LOAD
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            // Redirect to login if not authenticated
            window.location.href = "login.html";
            return;
        }

        // LOAD STUDENTS: Only show those assigned to THIS driver UID
        const q = query(collection(db, "students"), where("driverUid", "==", user.uid));
        
        onSnapshot(q, (snap) => {
            const list = document.getElementById('routeList');
            list.innerHTML = ""; // Clear loader
            
            if (snap.empty) {
                list.innerHTML = "<p style='text-align:center; color:#888;'>No students assigned to your route yet.</p>";
                return;
            }

            snap.forEach(d => {
                const s = d.data();
                list.innerHTML += `
                    <div class="student-card">
                        <h3>${s.name}</h3>
                        <p>üìç <strong>Pickup:</strong> ${s.address}</p>
                        <p>Current Status: <span id="status-msg">${s.status || 'Awaiting'}</span></p>
                        <div class="actions">
                            <button style="background:#ff9800" onclick="updateStatus('${d.id}', 'Bus is Near')">Near</button>
                            <button style="background:#28a745" onclick="updateStatus('${d.id}', 'On Board')">Picked Up</button>
                            <button style="background:#007bff" onclick="updateStatus('${d.id}', 'Dropped Off')">Dropped</button>
                            <button style="background:#dc3545" onclick="updateStatus('${d.id}', 'Absent')">Absent</button>
                        </div>
                    </div>`;
            });
        });
    });

    // 4. UPDATE STATUS FUNCTION
    window.updateStatus = async (id, newStatus) => {
        try {
            const studentRef = doc(db, "students", id);
            await updateDoc(studentRef, { 
                status: newStatus,
                lastUpdate: new Date() 
            });
            console.log("Status updated to:", newStatus);
        } catch (error) {
            console.error("Error updating status:", error);
            alert("Failed to update status. Check your internet connection.");
        }
    };
</script>
</body>
</html>
